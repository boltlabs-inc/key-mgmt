<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Implementation of our LockKeeper server."><title>key_server_cli - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../static.files/rustdoc-9bb858ba049f1f21.css" id="mainThemeStyle"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="key_server_cli" data-themes="" data-resource-suffix="" data-rustdoc-version="1.72.0 (5680fa18f 2023-08-23)" data-channel="1.72.0" data-search-js="search-f6292fe389d70017.js" data-settings-js="settings-de11bff964e9d4e5.js" data-settings-css="settings-8c76f75bfb6bd192.css" data-theme-light-css="light-0f8c037637f9eb3e.css" data-theme-dark-css="dark-1097f8e92a01e3cf.css" data-theme-ayu-css="ayu-614652228113ac93.css" ><script src="../static.files/storage-59fd9b8ccb335783.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-0795b7d26be81095.js"></script><noscript><link rel="stylesheet" media="(prefers-color-scheme:light)" href="../static.files/light-0f8c037637f9eb3e.css"><link rel="stylesheet" media="(prefers-color-scheme:dark)" href="../static.files/dark-1097f8e92a01e3cf.css"><link rel="stylesheet" href="../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../key_server_cli/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../key_server_cli/index.html"><img class="rust-logo" src="../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Crate key_server_cli</a></h2><div class="sidebar-elems"><ul class="block"><li class="version">Version 1.8.0</li><li><a id="all-types" href="all.html">All Items</a></li></ul><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#functions">Functions</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‚ÄòS‚Äô to search, ‚Äò?‚Äô for more options‚Ä¶" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Crate <a class="mod" href="#">key_server_cli</a><button id="copy-path" title="Copy item path to clipboard"><img src="../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../src/key_server_cli/main.rs.html#1-448">source</a> ¬∑ <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Implementation of our LockKeeper server.</p>
<h3 id="logging"><a href="#logging">Logging</a></h3>
<p>Our server supports logging using the <a href="https://docs.rs/tracing/latest/tracing/"><code>tracing</code></a>
crate.</p>
<h4 id="main-tracing-concepts"><a href="#main-tracing-concepts">Main <code>tracing</code> Concepts.</a></h4>
<p>We utilize the following concept from <code>tracing</code>:</p>
<ul>
<li><strong>Events</strong>: These are the individual logging events that are called as our
program executes.
Events have an info level attached to them. You may create a new event by
using the appropriate macro event macro from <code>tracing</code>, e.g:</li>
</ul>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">info!</span>(<span class="string">&quot;This is a logging event!&quot;</span>);</code></pre></div>
<p>You may add runtime values to our events as well:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="macro">info!</span>(<span class="string">&quot;Logging config settings: {:?}&quot;</span>, config.logging);</code></pre></div>
<p>This uses the same syntax as Rust string formatting.</p>
<ul>
<li><strong>Spans</strong> represent logical regions of code, usually a function. All
_event_s within a span
will have additional span data attached to the event. This allows us to add
context-relevant data to an event without having to explicitly add this data
to our event. For example an event like <code>info!(This operation completed successfully!)</code> within our span will look like:</li>
</ul>
<div class="example-wrap"><pre class="language-text"><code>  2022-12-06T18:57:40.022422Z  INFO lock_keeper_key_server::server::operation: This operation completed successfully!
    at lock-keeper-key-server/src/server/operation.rs:72
    in lock_keeper_key_server::server::operation::handle_request with request_id: &quot;52ad8008-1eb9-4ad5-8bce-0344a958fd1e&quot;, action: &quot;Authenticate&quot;
</code></pre></div>
<p>This event has the <code>handle_request</code> span attached to it. Additionally, spans
may contain <em>fields</em>. These fields attached relevant data to all events
within our span. In the log message above, we see our span has fields
<code>request_id</code> and <code>action</code> attached.</p>
<h5 id="adding-your-own-span"><a href="#adding-your-own-span">Adding your Own Span.</a></h5>
<p>The best way to create your own span is using the
<a href="https://docs.rs/tracing/0.1.37/tracing/attr.instrument.html"><code>instrument</code></a> macro. This macro
will automatically create a new span when the instrumented function is
called. This span will have the name of the function and the module path as
the <code>target</code> (this can be used for filtering by certain targets).</p>
<p>Please follow the following template for instrumenting your function with
spans:</p>
<div class="example-wrap"><pre class="language-text"><code>#[instrument(skip(sensitive_arg), err(Debug))]
fn foo(arg1: _, arg2: _, sensitive_arg SuperSecret) -&gt; _ {}
</code></pre></div>
<p>By default, <code>instrument</code> will create a new span where every argument to a
function is a span field. <em>This is not desirable for our key server as we
want to avoid logging sensitive data!</em> Make sure to skip sensitive arguments
with the <code>skip(sensitive_arg_1, sensitive_arg_2)</code> option. You can also use
the <code>skip_all</code> option if none of the function arguments need to be logged.</p>
<p>Finally, the <code>err(Debug)</code> option tells <code>tracing</code> that any <code>Result::Err(_)</code>
returned from this function should be logged as events (with the default
level of <code>INFO</code>). This is useful for logging where errors originated from in
our code. The <code>Debug</code> part tells tracing to use the <code>Debug</code> implementation
of this type for formatting, instead of the default <code>Display</code>.</p>
<p>Note that by default, return values of functions are not recorded. You can
add the <code>ret</code> option to <code>instrument</code> if you wish to record the Ok(_) return
value as a field.</p>
<p><code>tracing</code> relies on the <code>Debug</code> implementation of types for printing values.
Your type must implement <code>Debug</code> if you wish to include it as a field.</p>
<h5 id="recording-fields-not-immediately-available-as-arguments"><a href="#recording-fields-not-immediately-available-as-arguments">Recording Fields Not Immediately Available as Arguments.</a></h5>
<p>Sometimes we want to add a field to a span where the field data isn‚Äôt
immediately available as an argument to the function. Consider the following
example:</p>
<div class="example-wrap"><pre class="language-text"><code>#[instrument(skip_all, err(Debug), fields(action, user_id, request_id))]
    async fn handle_request(
        self,
        mut context: Context&lt;DB&gt;,
        request: Request&lt;Streaming&lt;Message&gt;&gt;,
    ) -&gt; Result&lt;_, _&gt; {

        let request_id = Uuid::new_v4();
        logging::record_field(&quot;request_id&quot;, &amp;request_id);
        info!(&quot;Handling new client request.&quot;);

        ... // Lots more things happen afterwards.
    }
</code></pre></div>
<p>Here we specify the fields <code>action</code>, <code>user_id</code>, <code>request_id</code> even though
none of these are function arguments! When the function body executes, we
create a <code>request_id</code> which we <em>record</em>
using our [record_field][lock_keeper::infrastructure::logging::record_field]
function. So our event <code>info!(&quot;Handling new client request.&quot;);</code> will have
the <code>request_id</code> field attached:</p>
<div class="example-wrap"><pre class="language-text"><code>  2022-12-06T18:57:39.667194Z  INFO
lock_keeper_key_server::server::operation: Handling new client request.
    at lock-keeper-key-server/src/server/operation.rs:48
    in lock_keeper_key_server::server::operation::handle_request with request_id: &quot;52ad8008-1eb9-4ad5-8bce-0344a958fd1e&quot;
</code></pre></div>
<p>Notice we have not recorded the <code>action</code> and <code>request_id</code> fields by the time
this event is logged, so these fields are not included. Span fields can be
recorded later as long as they are declared along with the span.</p>
<p>Note: While it is possible to create your own spans, it is not recommended.
The <code>instrument</code> macro handles spans for asynchronous functions. Ensuring
spans are properly kept track of, even when <code>.await</code>ing across spans.</p>
<h5 id="which-arguments-should-be-recorded-as-fields"><a href="#which-arguments-should-be-recorded-as-fields">Which Arguments Should be Recorded as Fields?</a></h5>
<p>In general, we should only include fields for our span that provide
important information that should be attached to every event that happens
within that span.</p>
<p>Fields are useful for attaching data to every event without having to
explicitly pass that data to the event.</p>
<p>Note: <em>We should be careful to avoid recording any sensitive data as
fields!</em></p>
<h5 id="which-function-should-be-instrumented"><a href="#which-function-should-be-instrumented">Which Function Should be <code>instrument</code>ed?</a></h5>
<p>We want to instrument functions which either:</p>
<ol>
<li>Logically represent an important step in our server processing.</li>
<li>Record useful fields to be attached to event within that span.</li>
<li>Have return values which are useful to log.</li>
</ol>
<p>Instrumenting multiple functions which call each other will create a useful
‚Äúbacktrace-like‚Äù context which allows us to understand the calling context
of an event. For example:</p>
<div class="example-wrap"><pre class="language-text"><code>  2022-12-06T18:57:39.669808Z  INFO
lock_keeper_key_server::operations::authenticate: Starting authentication protocol.
    at lock-keeper-key-server/src/operations/authenticate.rs:38
    in lock_keeper_key_server::operations::authenticate::operation
    in lock_keeper_key_server::server::operation::handle_request with request_id: &quot;52ad8008-1eb9-4ad5-8bce-0344a958fd1e&quot;, action: &quot;Authenticate&quot;
</code></pre></div>
<p>We want to avoid instrumenting uninteresting functions, e.g. functions which
represent an implementation detail instead of a logical step in our server
execution.</p>
<h4 id="logging-levels"><a href="#logging-levels">Logging Levels</a></h4>
<p>So far our logging documentation has focused on the default tracing level of
<code>INFO</code>. Events may be added for the following tracing levels: <code>error</code>,
<code>warn</code>, <code>info</code>, <code>debug</code>, and <code>trace</code>. Here we give a brief overview of what
falls under every level:</p>
<ul>
<li><strong>error</strong>: Report unexpected errors or failures in the system.</li>
<li><strong>warn</strong>: Warn of unexpected errors, unforeseen program states, or
possible issues that are not necessarily fatal, but should be logged so
they may be debugged later.</li>
<li><strong>info</strong>: For high-level, relevant, events to the execution of the code.
This is our default
logging level and should produce useful messages for developers.</li>
<li><strong>debug</strong>: More verbose, good to have information for debugging purposes.</li>
<li><strong>trace</strong>: Very verbose information that allows you to trace the execution
of a program at a
fine granularity, e.g. program control flow.</li>
</ul>
</div></details><h2 id="modules" class="small-section-header"><a href="#modules">Modules</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="config/index.html" title="mod key_server_cli::config">config</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Config for key server binary.</div></li></ul><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Cli.html" title="struct key_server_cli::Cli">Cli</a></div></li><li><div class="item-name"><a class="struct" href="struct.LoggingGuards.html" title="struct key_server_cli::LoggingGuards">LoggingGuards</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Object representing our logging. Should be kept around as our logging
writers return guards that should live for the lifetime of the program. Do
not do anything with the guards. Just make sure they are not dropped!</div></li></ul><h2 id="functions" class="small-section-header"><a href="#functions">Functions</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.get_database_config.html" title="fn key_server_cli::get_database_config">get_database_config</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.get_paths.html" title="fn key_server_cli::get_paths">get_paths</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Return the path directory and the file name. Needed for passing to
tracing_appender.</div></li><li><div class="item-name"><a class="fn" href="fn.get_session_cache_config.html" title="fn key_server_cli::get_session_cache_config">get_session_cache_config</a><span title="Restricted Visibility">&nbsp;üîí</span> </div></li><li><div class="item-name"><a class="fn" href="fn.init_logging.html" title="fn key_server_cli::init_logging">init_logging</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Initialize our logging with different logging layers:</div></li><li><div class="item-name"><a class="fn" href="fn.main.html" title="fn key_server_cli::main">main</a></div></li><li><div class="item-name"><a class="fn" href="fn.our_targets_filter.html" title="fn key_server_cli::our_targets_filter">our_targets_filter</a><span title="Restricted Visibility">&nbsp;üîí</span> </div><div class="desc docblock-short">Create filters for logging events originating from our lock_keeper*
crates.</div></li><li><div class="item-name"><a class="fn" href="fn.run_main.html" title="fn key_server_cli::run_main">run_main</a></div></li></ul></section></div></main></body></html>